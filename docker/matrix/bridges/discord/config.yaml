# Fantasy Markets Platform - Discord Bridge Configuration
# https://docs.mau.fi/bridges/go/discord/config.html

# Homeserver details
homeserver:
  address: http://synapse:8008
  domain: ${MATRIX_SERVER_NAME:-matrix.fantasy.local}
  software: standard
  status_endpoint: null
  message_send_checkpoint_target: null
  async_media: false

# Application service host/registration related details
appservice:
  address: http://mautrix-discord:29334
  hostname: 0.0.0.0
  port: 29334
  database:
    type: postgres
    uri: postgres://${MATRIX_DB_USER:-synapse}:${MATRIX_DB_PASSWORD:-synapse_password}@postgres-matrix/mautrix_discord?sslmode=disable
    max_open_conns: 20
    max_idle_conns: 2
    max_conn_idle_time: null
    max_conn_lifetime: null
  id: discord
  bot:
    username: discordbot
    displayname: Discord Bridge Bot
    avatar: mxc://maunium.net/nIdEykemnwdisvHbpxflpDlC
  ephemeral_events: true
  async_transactions: false
  as_token: ${DISCORD_AS_TOKEN:-GENERATE_NEW_TOKEN}
  hs_token: ${DISCORD_HS_TOKEN:-GENERATE_NEW_TOKEN}

# Bridge config
bridge:
  username_template: discord_{{.}}
  displayname_template: "{{.Username}}#{{.Discriminator}}"
  channel_name_template: "#{{.Name}}"
  guild_name_template: "{{.Name}}"
  private_chat_portal_meta: always
  portal_message_buffer: 128
  startup_private_channel_create_limit: 5
  delivery_receipts: true
  message_status_events: false
  message_error_notices: true
  restricted_rooms: true
  autojoin_thread_on_open: true
  sync_direct_chat_list: true
  resend_bridge_info: false

  # Backfill settings
  backfill:
    enabled: true
    forward_limits:
      initial:
        dm: 50
        channel: 100
        thread: 50
      incremental:
        dm: 50
        channel: 100
        thread: 50
    max_guild_members: 2500

  # Media settings
  animated_sticker:
    target: webp
    convert_from_webm: true
    args:
      width: 256
      height: 256
      fps: 10

  cache_media: never

  # Command prefix
  command_prefix: "!discord"

  # Double puppet
  double_puppet_server_map:
    ${MATRIX_SERVER_NAME:-matrix.fantasy.local}: ${MATRIX_DOMAIN:-https://matrix.fantasy.local}
  double_puppet_allow_discovery: false
  login_shared_secret_map:
    ${MATRIX_SERVER_NAME:-matrix.fantasy.local}: ${MATRIX_DOUBLE_PUPPET_SECRET:-}

  # Encryption
  encryption:
    allow: true
    default: true
    appservice: false
    require: false
    allow_key_sharing: true
    plaintext_mentions: false
    delete_keys:
      delete_outbound_on_ack: false
      dont_store_outbound: false
      ratchet_on_decrypt: false
      delete_fully_used_on_decrypt: false
      delete_prev_on_new_session: false
      delete_on_device_delete: false
      periodically_delete_expired: false
      delete_outdated_inbound: false
    verification_levels:
      receive: unverified
      send: unverified
      share: cross-signed-tofu
    rotation:
      enable_custom: false

  # Permissions
  permissions:
    "*": relay
    "${MATRIX_SERVER_NAME:-matrix.fantasy.local}": user
    "@admin:${MATRIX_SERVER_NAME:-matrix.fantasy.local}": admin

  # Relay mode
  relay:
    enabled: true
    message_formats:
      m.text: "<b>{{ .Sender.Displayname }}</b>: {{ .Message }}"
      m.notice: "<b>{{ .Sender.Displayname }}</b>: {{ .Message }}"
      m.emote: "* <b>{{ .Sender.Displayname }}</b> {{ .Message }}"
      m.file: "<b>{{ .Sender.Displayname }}</b> sent a file"
      m.image: "<b>{{ .Sender.Displayname }}</b> sent an image"
      m.audio: "<b>{{ .Sender.Displayname }}</b> sent an audio file"
      m.video: "<b>{{ .Sender.Displayname }}</b> sent a video"
      m.location: "<b>{{ .Sender.Displayname }}</b> sent a location"

# Logging
logging:
  min_level: debug
  writers:
    - type: stdout
      format: pretty-colored
    - type: file
      format: json
      filename: /data/logs/discord.log
      max_size: 100
      max_backups: 10
      compress: true
