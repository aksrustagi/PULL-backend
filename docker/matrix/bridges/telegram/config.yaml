# Fantasy Markets Platform - Telegram Bridge Configuration
# https://docs.mau.fi/bridges/python/telegram/config.html

# Homeserver details
homeserver:
  address: http://synapse:8008
  domain: ${MATRIX_SERVER_NAME:-matrix.fantasy.local}
  verify_ssl: false
  http_retry_count: 4
  status_endpoint: null
  message_send_checkpoint_target: null
  async_media: false
  software: standard

# Application service host/registration related details
appservice:
  address: http://mautrix-telegram:29336
  tls_cert: false
  tls_key: false
  hostname: 0.0.0.0
  port: 29336
  max_body_size: 1
  database: postgres://${MATRIX_DB_USER:-synapse}:${MATRIX_DB_PASSWORD:-synapse_password}@postgres-matrix/mautrix_telegram?sslmode=disable
  database_opts:
    min_size: 1
    max_size: 10
  id: telegram
  bot_username: telegrambot
  bot_displayname: Telegram Bridge Bot
  bot_avatar: mxc://maunium.net/tJCRmUyJDsgRNgqhOgoiHWbX
  ephemeral_events: true
  async_transactions: false
  as_token: ${TELEGRAM_AS_TOKEN:-GENERATE_NEW_TOKEN}
  hs_token: ${TELEGRAM_HS_TOKEN:-GENERATE_NEW_TOKEN}

# Telegram config
telegram:
  api_id: ${TELEGRAM_API_ID:-0}
  api_hash: ${TELEGRAM_API_HASH:-}
  bot_token: ${TELEGRAM_BOT_TOKEN:-}

  # Connection settings
  connection:
    timeout: 120
    retries: 5
    retry_delay: 1
    flood_sleep_threshold: 60
    request_retries: 5
    device_model: mautrix-telegram
    system_version: auto
    app_version: auto
    lang_code: en
    system_lang_code: en

  # Proxy (if needed)
  proxy:
    type: disabled
    address: null
    port: null
    rdns: true
    username: null
    password: null

  # Update handling
  catch_up: true
  sequential_updates: true
  exit_on_update_error: false

# Bridge config
bridge:
  username_template: telegram_{userid}
  alias_template: telegram_{groupname}
  displayname_template: "{displayname} (Telegram)"

  displayname_preference:
    - full name
    - username
    - phone number

  # Room settings
  displayname_max_length: 100
  allow_avatar_remove: false
  allow_contact_info: false
  max_initial_member_sync: 100
  max_member_count: -1
  sync_channel_members: true
  skip_deleted_members: true
  startup_sync: true
  sync_create_limit: 15
  sync_update_limit: 0
  sync_direct_chats: true
  max_telegram_delete: 10
  sync_matrix_state: true

  # Backfill
  backfill:
    enable: true
    normal_groups: 10
    msc2716: false
    unread_hours_threshold: 720
    forward_limits:
      initial:
        user: 10
        normal_group: 10
        supergroup: 10
        channel: 10
      sync:
        user: 10
        normal_group: 10
        supergroup: 10
        channel: 10
    incremental:
      messages_per_batch: 100
      post_batch_delay: 20
      max_batches: 30

  # Permissions
  allow_matrix_login: true
  public_portals: false
  sync_direct_chat_list: true
  resend_bridge_info: false
  mute_bridging: false
  pinned_tag: null
  archive_tag: null
  allow_small_group_upgrades: false

  # Media
  animated_sticker:
    target: webp
    convert_from_webm: true
    args:
      width: 256
      height: 256
      fps: 30
      background: "020202"
  animated_emoji:
    target: webp
    args:
      width: 64
      height: 64
      fps: 25

  state_event_formats:
    join: ""
    leave: ""
    name_change: ""

  filter:
    mode: blacklist
    list: []

  # Command prefix
  command_prefix: "!tg"

  # Double puppet
  double_puppet_server_map:
    ${MATRIX_SERVER_NAME:-matrix.fantasy.local}: ${MATRIX_DOMAIN:-https://matrix.fantasy.local}
  double_puppet_allow_discovery: false
  login_shared_secret_map:
    ${MATRIX_SERVER_NAME:-matrix.fantasy.local}: ${MATRIX_DOUBLE_PUPPET_SECRET:-}

  # Encryption
  encryption:
    allow: true
    default: true
    appservice: false
    require: false
    allow_key_sharing: true
    plaintext_mentions: false
    delete_keys:
      delete_outbound_on_ack: false
      dont_store_outbound: false
      ratchet_on_decrypt: false
      delete_fully_used_on_decrypt: false
      delete_prev_on_new_session: false
      delete_on_device_delete: false
      periodically_delete_expired: false
      delete_outdated_inbound: false
    verification_levels:
      receive: unverified
      send: unverified
      share: cross-signed-tofu
    rotation:
      enable_custom: false

  # Relay
  relay_user_distinguishers: []
  caption_in_message: false

  # Permissions
  permissions:
    "*": relaybot
    "${MATRIX_SERVER_NAME:-matrix.fantasy.local}": user
    "@admin:${MATRIX_SERVER_NAME:-matrix.fantasy.local}": admin

  relaybot:
    enabled: true
    private_chat:
      invite: []
      state_changes: true
      message: "This is a Matrix bridge relaybot and does not support private chat."
    group_chat_invite: []
    ignore_unbridged_group_chat: true
    authless_portals: true
    whitelist_group_admins: true
    ignore_own_incoming_events: true
    whitelist: []
    message_formats:
      m.text: "<b>{{ .Sender.Displayname }}</b>: {{ .Message }}"
      m.notice: "<b>{{ .Sender.Displayname }}</b>: {{ .Message }}"
      m.emote: "* <b>{{ .Sender.Displayname }}</b> {{ .Message }}"
      m.file: "<b>{{ .Sender.Displayname }}</b> sent a file"
      m.image: "<b>{{ .Sender.Displayname }}</b> sent an image"
      m.audio: "<b>{{ .Sender.Displayname }}</b> sent an audio file"
      m.video: "<b>{{ .Sender.Displayname }}</b> sent a video"
      m.location: "<b>{{ .Sender.Displayname }}</b> sent a location"

# Logging
logging:
  version: 1
  formatters:
    colored:
      (): mautrix_telegram.util.ColorFormatter
      format: "[%(asctime)s] [%(levelname)s@%(name)s] %(message)s"
    normal:
      format: "[%(asctime)s] [%(levelname)s@%(name)s] %(message)s"
  handlers:
    console:
      class: logging.StreamHandler
      formatter: colored
    file:
      class: logging.handlers.RotatingFileHandler
      formatter: normal
      filename: /data/logs/telegram.log
      maxBytes: 10485760
      backupCount: 10
  loggers:
    mau:
      level: DEBUG
    telethon:
      level: INFO
    aiohttp:
      level: INFO
  root:
    level: DEBUG
    handlers: [console, file]
