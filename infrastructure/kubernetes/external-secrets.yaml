# External Secrets Operator Configuration
# Uses External Secrets Operator to sync secrets from external secret stores (AWS Secrets Manager, GCP Secret Manager, HashiCorp Vault, etc.)
# See: https://external-secrets.io/

---
# ClusterSecretStore for GCP Secret Manager (can be adapted for AWS/Vault)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: pull-gcp-secret-store
  namespace: pull
  labels:
    app.kubernetes.io/name: pull
    app.kubernetes.io/component: secrets
spec:
  provider:
    gcpsm:
      projectID: ${GCP_PROJECT_ID}  # Replace with actual project ID or use variable substitution
      auth:
        workloadIdentity:
          clusterLocation: ${GCP_CLUSTER_LOCATION}
          clusterName: ${GCP_CLUSTER_NAME}
          clusterProjectID: ${GCP_PROJECT_ID}
          serviceAccountRef:
            name: pull-secrets-sa
---
# Alternative: AWS Secrets Manager SecretStore
# Uncomment and configure if using AWS
# apiVersion: external-secrets.io/v1beta1
# kind: SecretStore
# metadata:
#   name: pull-aws-secret-store
#   namespace: pull
# spec:
#   provider:
#     aws:
#       service: SecretsManager
#       region: us-east-1
#       auth:
#         jwt:
#           serviceAccountRef:
#             name: pull-secrets-sa
---
# Alternative: HashiCorp Vault SecretStore
# Uncomment and configure if using Vault
# apiVersion: external-secrets.io/v1beta1
# kind: SecretStore
# metadata:
#   name: pull-vault-secret-store
#   namespace: pull
# spec:
#   provider:
#     vault:
#       server: "https://vault.example.com"
#       path: "secret"
#       version: "v2"
#       auth:
#         kubernetes:
#           mountPath: "kubernetes"
#           role: "pull-app"
#           serviceAccountRef:
#             name: pull-secrets-sa
---
# Main application secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pull-secrets
  namespace: pull
  labels:
    app.kubernetes.io/name: pull
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: pull-gcp-secret-store
    kind: SecretStore
  target:
    name: pull-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: pull
          app.kubernetes.io/component: secrets
  data:
    # Database credentials
    - secretKey: redis-url
      remoteRef:
        key: pull-production-redis-url
        version: latest

    # Convex
    - secretKey: convex-url
      remoteRef:
        key: pull-production-convex-url
        version: latest
    - secretKey: convex-deploy-key
      remoteRef:
        key: pull-production-convex-deploy-key
        version: latest

    # Kalshi API
    - secretKey: kalshi-api-key-id
      remoteRef:
        key: pull-production-kalshi-api-key-id
        version: latest
    - secretKey: kalshi-private-key
      remoteRef:
        key: pull-production-kalshi-private-key
        version: latest

    # Plaid
    - secretKey: plaid-client-id
      remoteRef:
        key: pull-production-plaid-client-id
        version: latest
    - secretKey: plaid-secret
      remoteRef:
        key: pull-production-plaid-secret
        version: latest

    # Clerk Auth
    - secretKey: clerk-secret-key
      remoteRef:
        key: pull-production-clerk-secret-key
        version: latest
    - secretKey: clerk-publishable-key
      remoteRef:
        key: pull-production-clerk-publishable-key
        version: latest

    # Encryption keys
    - secretKey: encryption-key
      remoteRef:
        key: pull-production-encryption-key
        version: latest
    - secretKey: jwt-secret
      remoteRef:
        key: pull-production-jwt-secret
        version: latest
---
# TLS certificates for internal communication
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: pull-internal-tls
  namespace: pull
  labels:
    app.kubernetes.io/name: pull
    app.kubernetes.io/component: tls
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: pull-gcp-secret-store
    kind: SecretStore
  target:
    name: pull-internal-tls
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
  data:
    - secretKey: tls.crt
      remoteRef:
        key: pull-internal-tls-cert
        version: latest
    - secretKey: tls.key
      remoteRef:
        key: pull-internal-tls-key
        version: latest
---
# Service Account for External Secrets (GCP Workload Identity)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pull-secrets-sa
  namespace: pull
  labels:
    app.kubernetes.io/name: pull
    app.kubernetes.io/component: secrets
  annotations:
    # GCP Workload Identity annotation
    iam.gke.io/gcp-service-account: pull-secrets@${GCP_PROJECT_ID}.iam.gserviceaccount.com
    # AWS IRSA annotation (if using AWS)
    # eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/pull-secrets-role
---
# Fallback: Manual secrets template for development/testing
# In production, use ExternalSecret above instead
apiVersion: v1
kind: Secret
metadata:
  name: pull-secrets-template
  namespace: pull
  labels:
    app.kubernetes.io/name: pull
    app.kubernetes.io/component: secrets
  annotations:
    description: "Template for manual secret creation - DO NOT use in production"
type: Opaque
stringData:
  # PLACEHOLDER VALUES - Replace before applying
  redis-url: "redis://localhost:6379"
  convex-url: "https://your-deployment.convex.cloud"
  convex-deploy-key: "REPLACE_ME"
  kalshi-api-key-id: "REPLACE_ME"
  kalshi-private-key: "REPLACE_ME"
  plaid-client-id: "REPLACE_ME"
  plaid-secret: "REPLACE_ME"
  clerk-secret-key: "REPLACE_ME"
  clerk-publishable-key: "REPLACE_ME"
  encryption-key: "REPLACE_ME_WITH_32_BYTE_KEY"
  jwt-secret: "REPLACE_ME_WITH_SECURE_SECRET"
