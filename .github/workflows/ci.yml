name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

jobs:
  # ==========================================================================
  # Changes Detection - Skip unnecessary work
  # ==========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      api: ${{ steps.filter.outputs.api }}
      web: ${{ steps.filter.outputs.web }}
      core: ${{ steps.filter.outputs.core }}
      workers: ${{ steps.filter.outputs.workers }}
      db: ${{ steps.filter.outputs.db }}
      any: ${{ steps.filter.outputs.any }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'packages/core/**'
              - 'packages/types/**'
            web:
              - 'apps/web/**'
              - 'packages/ui/**'
              - 'packages/types/**'
            core:
              - 'packages/core/**'
              - 'packages/types/**'
            workers:
              - 'apps/workers/**'
              - 'packages/core/**'
            db:
              - 'packages/db/**'
            any:
              - '**/*.ts'
              - '**/*.tsx'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'turbo.json'

  # ==========================================================================
  # Quality Checks - Run in parallel matrix for speed
  # ==========================================================================
  quality:
    name: Quality (${{ matrix.task }})
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.any == 'true'
    strategy:
      fail-fast: false
      matrix:
        task: [lint, typecheck]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}

      - name: Run ${{ matrix.task }}
        run: pnpm ${{ matrix.task }}

      - name: Report Results
        if: always()
        run: |
          echo "## ${{ matrix.task }} Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "All checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "Some checks failed - see logs above" >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # Convex Type Check - Runs in parallel with quality
  # ==========================================================================
  convex-typecheck:
    name: Convex Type Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.db == 'true' || needs.changes.outputs.any == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}

      - name: Convex codegen
        run: pnpm --filter @pull/db codegen
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Type check Convex functions
        run: pnpm --filter @pull/db typecheck

  # ==========================================================================
  # Build - Runs in parallel with quality checks (uses Turbo cache)
  # ==========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.any == 'true'
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}

      - name: Generate cache key
        id: cache-key
        run: echo "key=build-${{ runner.os }}-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build all packages
        run: pnpm build

      - name: Cache build artifacts
        uses: actions/cache/save@v4
        with:
          path: |
            apps/**/dist
            apps/**/.next
            packages/**/dist
            !apps/**/.next/cache
          key: ${{ steps.cache-key.outputs.key }}

      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages Built" >> $GITHUB_STEP_SUMMARY
          find apps packages -name "dist" -type d 2>/dev/null | while read dir; do
            echo "- $dir" >> $GITHUB_STEP_SUMMARY
          done

  # ==========================================================================
  # Unit Tests - Requires build
  # ==========================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [build, quality]
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            apps/**/dist
            apps/**/.next
            packages/**/dist
            !apps/**/.next/cache
          key: ${{ needs.build.outputs.cache-key }}

      - name: Run tests with coverage
        run: pnpm test:run --coverage
        env:
          NODE_ENV: test

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "### Coverage Summary" >> $GITHUB_STEP_SUMMARY
            node -e "
              const coverage = require('./coverage/coverage-summary.json');
              const total = coverage.total;
              console.log('| Metric | Coverage |');
              console.log('|--------|----------|');
              console.log('| Lines | ' + total.lines.pct + '% |');
              console.log('| Statements | ' + total.statements.pct + '% |');
              console.log('| Functions | ' + total.functions.pct + '% |');
              console.log('| Branches | ' + total.branches.pct + '% |');
            " >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Coverage data not available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

  # ==========================================================================
  # E2E Tests - Requires build, runs on main and develop only
  # ==========================================================================
  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build, quality]
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'run-e2e')
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}

      - name: Restore build artifacts
        uses: actions/cache/restore@v4
        with:
          path: |
            apps/**/dist
            apps/**/.next
            packages/**/dist
            !apps/**/.next/cache
          key: ${{ needs.build.outputs.cache-key }}

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Playwright deps only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      - name: Run E2E tests
        run: pnpm test:e2e
        env:
          CI: true
          E2E_BASE_URL: http://localhost:3000

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 7

  # ==========================================================================
  # CI Summary - Final status check
  # ==========================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [quality, build, test, convex-typecheck]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          quality_result="${{ needs.quality.result }}"
          build_result="${{ needs.build.result }}"
          test_result="${{ needs.test.result }}"
          convex_result="${{ needs.convex-typecheck.result }}"

          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | $quality_result |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | $build_result |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | $test_result |" >> $GITHUB_STEP_SUMMARY
          echo "| Convex | $convex_result |" >> $GITHUB_STEP_SUMMARY

          if [[ "$quality_result" == "failure" || "$build_result" == "failure" || "$test_result" == "failure" || "$convex_result" == "failure" ]]; then
            echo ""
            echo "### Some jobs failed - please check the logs above"
            exit 1
          fi

          echo ""
          echo "### All checks passed!"

      - name: Fail if required jobs failed
        if: |
          needs.quality.result == 'failure' ||
          needs.build.result == 'failure' ||
          needs.test.result == 'failure'
        run: exit 1
