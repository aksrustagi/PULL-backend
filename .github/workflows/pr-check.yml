name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

# This workflow provides PR-specific checks that complement the main CI workflow.
# Heavy lifting (lint, typecheck, test, build) is handled by ci.yml
# This workflow focuses on lightweight, fast PR validation checks.

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          # Allow common conventional commit prefixes
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?:.*$ ]]; then
            echo "::warning::PR title doesn't follow conventional commit format"
            echo "Expected format: type(scope): description"
            echo "Examples: feat: add new feature, fix(api): resolve bug"
          fi

      - name: Check for debugging statements
        run: |
          echo "## Code Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for console.log in changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.ts' '*.tsx' ':!*.test.ts' ':!*.spec.ts' 2>/dev/null || echo "")

          if [ -n "$CHANGED_FILES" ]; then
            CONSOLE_LOGS=$(echo "$CHANGED_FILES" | xargs grep -l "console\.log" 2>/dev/null || echo "")
            if [ -n "$CONSOLE_LOGS" ]; then
              echo "### Warning: console.log found in:" >> $GITHUB_STEP_SUMMARY
              echo "$CONSOLE_LOGS" | while read file; do
                echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
              done
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "::warning::Found console.log statements in changed files. Consider removing before merge."
            else
              echo "No console.log statements found in changed files" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Check for TODO/FIXME comments
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.ts' '*.tsx' 2>/dev/null || echo "")

          if [ -n "$CHANGED_FILES" ]; then
            TODO_FILES=$(echo "$CHANGED_FILES" | xargs grep -l -E "(TODO|FIXME|XXX|HACK):" 2>/dev/null || echo "")
            if [ -n "$TODO_FILES" ]; then
              echo "### Note: TODO/FIXME comments found in:" >> $GITHUB_STEP_SUMMARY
              echo "$TODO_FILES" | while read file; do
                echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Check file size
        run: |
          # Warn about large files being added
          LARGE_FILES=$(git diff --name-only --diff-filter=A origin/${{ github.base_ref }}...HEAD | while read file; do
            if [ -f "$file" ]; then
              SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
              if [ "$SIZE" -gt 1000000 ]; then  # 1MB
                echo "$file ($(numfmt --to=iec-i --suffix=B $SIZE 2>/dev/null || echo "${SIZE}B"))"
              fi
            fi
          done)

          if [ -n "$LARGE_FILES" ]; then
            echo "### Warning: Large files detected:" >> $GITHUB_STEP_SUMMARY
            echo "$LARGE_FILES" | while read file; do
              echo "- $file" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Large files detected. Consider using Git LFS or reducing file size."
          fi

      - name: PR Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### PR Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target:** ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commits:** ${{ github.event.pull_request.commits }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed Files:** ${{ github.event.pull_request.changed_files }}" >> $GITHUB_STEP_SUMMARY

  # Ensure CI workflow runs for PRs (acts as a required status check)
  ci-required:
    name: CI Required
    runs-on: ubuntu-latest
    steps:
      - name: Check CI workflow status
        run: |
          echo "This job ensures CI runs for all PRs."
          echo "The main CI workflow handles: lint, typecheck, build, and test"
          echo "See the CI workflow run for detailed results."
